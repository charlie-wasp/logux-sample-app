!function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=23)}([function(t,e,n){(t.exports=function(){this.events={}}).prototype={on:function(t,e){return(t=this.events[t]=this.events[t]||[]).push(e),function(){t.splice(t.indexOf(e)>>>0,1)}},emit:function(t){var e=this.events[t];if(e&&e[0]){var n=e.slice.call(arguments,1);e.slice().map(function(t){t.apply(this,n)})}}}},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e){t.exports=function(t,e){for(var n in t||(t={}),e)void 0===t[n]&&(t[n]=e[n]);return t}},function(t,e){function n(t,e,i,o){Error.call(this,e),this.name="SyncError",this.type=e,this.options=i,this.description=n.describe(e,i),this.sync=t,this.received=!!o,this.message="",o?(this.sync.remoteNodeId?this.message+=this.sync.remoteNodeId+" sent ":this.message+="Logux received ",this.message+=this.type+" error",this.description!==this.type&&(this.message+=" ("+this.description+")")):this.message=this.description,Error.captureStackTrace&&Error.captureStackTrace(this,n)}n.describe=function(t,e){return"timeout"===t?"A timeout was reached ("+e+"ms)":"wrong-format"===t?"Wrong message format in "+e:"unknown-message"===t?"Unknown message `"+e+"` type":"missed-auth"===t?"Start authentication before sending message "+e:"wrong-protocol"===t?"Logux supports protocols only from version "+e.supported+", but you use "+e.used:"wrong-subprotocol"===t?"Only "+e.supported+" application subprotocols are supported, but you use "+e.used:"wrong-credentials"===t?"Wrong credentials":t},n.prototype=Error.prototype,t.exports=n},function(t,e){t.exports=function(t,e){if(t&&!e)return!1;if(!t&&e)return!0;if(t.time>e.time)return!1;if(t.time<e.time)return!0;var n=t.id.slice(1).join("\t"),i=e.id.slice(1).join("\t");return!(n>i)&&(n<i||!(t.id[0]>e.id[0])&&t.id[0]<e.id[0])}},function(t,e,n){"use strict";(function(e){function n(t){o.length||(i(),!0),o[o.length]=t}t.exports=n;var i,o=[],s=0,r=1024;function c(){for(;s<o.length;){var t=s;if(s+=1,o[t].call(),s>r){for(var e=0,n=o.length-s;e<n;e++)o[e]=o[e+s];o.length-=s,s=0}}o.length=0,s=0,!1}var a,d,u,h=void 0!==e?e:self,l=h.MutationObserver||h.WebKitMutationObserver;function f(t){return function(){var e=setTimeout(i,0),n=setInterval(i,50);function i(){clearTimeout(e),clearInterval(n),t()}}}"function"==typeof l?(a=1,d=new l(c),u=document.createTextNode(""),d.observe(u,{characterData:!0}),i=function(){a=-a,u.data=a}):i=f(c),n.requestFlush=i,n.makeRequestCallFromTimer=f}).call(this,n(1))},function(t,e,n){"use strict";var i=n(5);function o(){}var s=null,r={};function c(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("Promise constructor's argument is not a function");this._75=0,this._83=0,this._18=null,this._38=null,t!==o&&f(t,this)}function a(t,e){for(;3===t._83;)t=t._18;if(c._47&&c._47(t),0===t._83)return 0===t._75?(t._75=1,void(t._38=e)):1===t._75?(t._75=2,void(t._38=[t._38,e])):void t._38.push(e);!function(t,e){i(function(){var n=1===t._83?e.onFulfilled:e.onRejected;if(null!==n){var i=function(t,e){try{return t(e)}catch(t){return s=t,r}}(n,t._18);i===r?u(e.promise,s):d(e.promise,i)}else 1===t._83?d(e.promise,t._18):u(e.promise,t._18)})}(t,e)}function d(t,e){if(e===t)return u(t,new TypeError("A promise cannot be resolved with itself."));if(e&&("object"==typeof e||"function"==typeof e)){var n=function(t){try{return t.then}catch(t){return s=t,r}}(e);if(n===r)return u(t,s);if(n===t.then&&e instanceof c)return t._83=3,t._18=e,void h(t);if("function"==typeof n)return void f(n.bind(e),t)}t._83=1,t._18=e,h(t)}function u(t,e){t._83=2,t._18=e,c._71&&c._71(t,e),h(t)}function h(t){if(1===t._75&&(a(t,t._38),t._38=null),2===t._75){for(var e=0;e<t._38.length;e++)a(t,t._38[e]);t._38=null}}function l(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function f(t,e){var n=!1,i=function(t,e,n){try{t(e,n)}catch(t){return s=t,r}}(t,function(t){n||(n=!0,d(e,t))},function(t){n||(n=!0,u(e,t))});n||i!==r||(n=!0,u(e,s))}t.exports=c,c._47=null,c._71=null,c._44=o,c.prototype.then=function(t,e){if(this.constructor!==c)return function(t,e,n){return new t.constructor(function(i,s){var r=new c(o);r.then(i,s),a(t,new l(e,n,r))})}(this,t,e);var n=new c(o);return a(this,new l(t,e,n)),n}},function(t,e,n){(function(e){var i=n(4),o=n(6);o.prototype.catch=function(t){return this.then(null,t)};function s(t,e){t.onerror=function(t){e(t.target.error)}}function r(t){return new o(function(e,n){s(t,n),t.onsuccess=function(t){e(t.target.result)}})}function c(t){return void 0!==t}function a(t){this.name=t||"logux",this.adding={}}a.prototype={init:function(){if(this.initing)return this.initing;var t=this,n=indexedDB.open(this.name,1);return n.onupgradeneeded=function(t){var e=t.target.result,n=e.createObjectStore("log",{keyPath:"added",autoIncrement:!0});n.createIndex("id","id",{unique:!0}),n.createIndex("created","created",{unique:!0}),n.createIndex("reasons","reasons",{multiEntry:!0}),e.createObjectStore("extra",{keyPath:"key"})},this.initing=r(n).then(function(n){return t.db=n,n.onversionchange=function(){t.db.close(),e.document&&e.document.reload&&e.document.reload()},t}),this.initing},get:function(t){var e;return this.init().then(function(n){var i=n.os("log");return r(e="created"===t.order?i.index("created").openCursor(null,"prev"):i.openCursor(null,"prev")).then(function t(e){return function(n){return n?(n.value.meta.added=n.value.added,{entries:[[n.value.action,n.value.meta]],next:function(){return n.continue(),r(e).then(t(e))}}):{entries:[]}}}(e))})},byId:function(t){return this.init().then(function(e){return r(e.os("log").index("id").get(t))}).then(function(t){return t?[t.action,t.meta]:[null,null]})},remove:function(t){return this.init().then(function(e){var n=e.os("log","write");return r(n.index("id").get(t)).then(function(t){return!!t&&r(n.delete(t.added)).then(function(){return t.meta.added=t.added,[t.action,t.meta]})})})},add:function(t,e){var n={id:e.id,meta:e,time:e.time,action:t,reasons:e.reasons,created:[e.time,e.id[1],e.id[2],e.id[0]].join("\t")};return this.adding[n.created]?new o(function(t){t(!1)}):(this.adding[n.created]=!0,this.init().then(function(t){var i=t.os("log","write");return r(i.index("id").get(e.id)).then(function(o){return!o&&r(i.add(n)).then(function(i){return delete t.adding[n.created],e.added=i,e})})}))},changeMeta:function(t,e){return this.init().then(function(n){var i=n.os("log","write");return r(i.index("id").get(t)).then(function(t){if(t){for(var n in e)t.meta[n]=e[n];return e.reasons&&(t.reasons=e.reasons),r(i.put(t)).then(function(){return!0})}return!1})})},removeReason:function(t,e,n){return this.init().then(function(r){var a=r.os("log","write"),d=a.index("reasons").openCursor(t);return new o(function(o,r){s(d,r),d.onsuccess=function(d){if(d.target.result){var u,h=d.target.result.value,l=h.meta,f=e;if(!c(f.olderThan)||i(l,f.olderThan))if(!c(f.youngerThan)||i(f.youngerThan,l))if(c(f.minAdded)&&h.added<f.minAdded)d.target.result.continue();else if(c(f.maxAdded)&&h.added>f.maxAdded)d.target.result.continue();else 1===h.reasons.length?(h.meta.reasons=[],h.meta.added=h.added,n(h.action,h.meta),u=a.delete(h.added)):(h.reasons.splice(h.reasons.indexOf(t),1),h.meta.reasons=h.reasons,u=a.put(h)),s(u,r),u.onsuccess=function(){d.target.result.continue()};else d.target.result.continue();else d.target.result.continue()}else o()}})})},getLastAdded:function(){return this.init().then(function(t){return r(t.os("log").openCursor(null,"prev"))}).then(function(t){return t?t.value.added:0})},getLastSynced:function(){return this.init().then(function(t){return r(t.os("extra").get("lastSynced"))}).then(function(t){return t?{sent:t.sent,received:t.received}:{sent:0,received:0}})},setLastSynced:function(t){return this.init().then(function(e){var n=e.os("extra","write");return r(n.get("lastSynced")).then(function(e){return e||(e={key:"lastSynced",sent:0,received:0}),void 0!==t.sent&&(e.sent=t.sent),void 0!==t.received&&(e.received=t.received),r(n.put(e))})})},os:function(t,e){var n=e?"readwrite":"readonly";return this.db.transaction(t,n).objectStore(t)},clean:function(){return this.init().then(function(t){return t.db.close(),r(e.indexedDB.deleteDatabase(t.name))})}},t.exports=a}).call(this,n(1))},function(t,e,n){var i=n(0);function o(t){if(t||(t={}),void 0===t.nodeId)throw new Error("Expected node ID");if("object"!=typeof t.store)throw new Error("Expected store");this.nodeId=t.nodeId,this.lastTime=0,this.sequence=0,this.store=t.store,this.emitter=new i}o.prototype={on:function(t,e){return this.emitter.on(t,e)},add:function(t,e){if(void 0===t.type)throw new Error('Expected "type" in action');e||(e={});var n=!1;void 0===e.id&&(n=!0,e.id=this.generateId()),void 0===e.time&&(e.time=e.id[0]),void 0===e.reasons?e.reasons=[]:Array.isArray(e.reasons)||(e.reasons=[e.reasons]),e.reasons.forEach(function(t){if("string"!=typeof t)throw new Error('Expected "reasons" to be strings')});var i=this;return this.emitter.emit("preadd",t,e),e.keepLast&&(this.removeReason(e.keepLast,{olderThan:e}),e.reasons.push(e.keepLast)),0===e.reasons.length&&n?(this.emitter.emit("add",t,e),this.emitter.emit("clean",t,e),Promise.resolve(e)):0===e.reasons.length?this.store.byId(e.id).then(function(n){return!n[0]&&(i.emitter.emit("add",t,e),i.emitter.emit("clean",t,e),e)}):this.store.add(t,e).then(function(e){return!1!==e&&(i.emitter.emit("add",t,e),e)})},generateId:function(){var t=Date.now();return t<=this.lastTime?(t=this.lastTime,this.sequence+=1):(this.lastTime=t,this.sequence=0),[t,this.nodeId,this.sequence]},each:function(t,e){e||(e=t,t={order:"created"});var n=this.store;return new Promise(function(i){!function t(n){n().then(function(n){for(var o,s=0;s<n.entries.length;s++){var r=n.entries[s];if(!1===(o=e(r[0],r[1])))break}!1!==o&&n.next?t(n.next):i()})}(n.get.bind(n,t))})},changeMeta:function(t,e){var n;for(n in e)if("id"===n||"added"===n||"time"===n)throw new Error('Meta "'+n+'" is read-only');var i=this.emitter;return e.reasons&&0===e.reasons.length?this.store.remove(t).then(function(t){if(t){for(n in e)t[1][n]=e[n];i.emit("clean",t[0],t[1])}return!!t}):this.store.changeMeta(t,e)},removeReason:function(t,e){e||(e={});var n=this;return this.store.removeReason(t,e,function(t,e){n.emitter.emit("clean",t,e)})},byId:function(t){return this.store.byId(t)}},t.exports=o},function(t,e){var n=self.crypto||self.msCrypto;t.exports=function(t){return n.getRandomValues(new Uint8Array(t))}},function(t,e,n){var i=n(9);t.exports=function(t){for(var e="",n=i(t=t||21);0<t--;)e+="_~0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[63&n[t]];return e}},function(t,e,n){var i=n(2),o={minDelay:1e3,maxDelay:5e3,attempts:1/0},s=["wrong-protocol","wrong-subprotocol","wrong-credentials"];function r(t,e){this.connection=t,this.options=i(e,o),this.reconnecting=t.connected,this.connecting=!1,this.attempts=0,this.unbind=[];var n=this;function r(){!n.reconnecting||n.connected||n.connecting||document.hidden||n.connect()}function c(){!n.reconnecting||n.connected||n.connecting||navigator.onLine&&n.connect()}this.unbind.push(this.connection.on("message",function(t){"error"===t[0]&&-1!==s.indexOf(t[1])&&(n.reconnecting=!1)})),this.unbind.push(this.connection.on("connecting",function(){n.connecting=!0})),this.unbind.push(this.connection.on("connect",function(){n.attempts=0,n.connecting=!1})),this.unbind.push(this.connection.on("disconnect",function(){n.connecting=!1,n.reconnecting&&n.reconnect()})),this.unbind.push(function(){clearTimeout(n.timer)}),"undefined"!=typeof navigator&&(document.addEventListener("visibilitychange",r,!1),window.addEventListener("online",c,!1),this.unbind.push(function(){document.removeEventListener("visibilitychange",r,!1),window.removeEventListener("online",c,!1)}))}r.prototype={connect:function(){return this.attempts+=1,this.reconnecting=!0,this.connection.connect()},disconnect:function(t){return"timeout"!==t&&"error"!==t&&(this.reconnecting=!1),this.connection.disconnect(t)},destroy:function(){for(var t=0;t<this.unbind.length;t++)this.unbind[t]();this.disconnect("destroy")},reconnect:function(){if(this.attempts>this.options.attempts-1)return this.reconnecting=!1,void(this.attempts=0);var t=this.nextDelay(),e=this;this.timer=setTimeout(function(){!e.reconnecting||e.connecting||e.connected||e.connect()},t)},send:function(){return this.connection.send.apply(this.connection,arguments)},on:function(){return this.connection.on.apply(this.connection,arguments)},nextDelay:function(){var t=this.options.minDelay*Math.pow(2,this.attempts),e=Math.random(),n=Math.floor(.5*e*t);return 1===Math.floor(10*e)&&(n=-n),Math.min(t+n,this.options.maxDelay)||0}},Object.defineProperty(r.prototype,"connected",{get:function(){return this.connection.connected}}),t.exports=r},function(t,e){t.exports={sendDebug:function(t,e){this.send(["debug",t,e])},debugMessage:function(t,e){this.emitter.emit("debug",t,e)}}},function(t,e){t.exports={sendSync:function(t,e){this.startTimeout();for(var n=[],i=0;i<e.length;i++){var o=e[i][1],s={};for(var r in o)"id"===r?s.id=o.id.slice(0):"added"!==r&&(s[r]=o[r]);this.timeFix&&(s.time-=this.timeFix),s.id[0]-=this.baseTime,s.time-=this.baseTime,s.id[1]===this.localNodeId&&(0===s.id[2]?s.id=s.id[0]:s.id=[s.id[0],s.id[2]]),n.unshift(e[i][0],s)}this.syncing+=1,this.setState("sending"),this.send(["sync",t].concat(n))},sendSynced:function(t){this.send(["synced",t])},syncMessage:function(t){for(var e=this,n=[],i=1;i<arguments.length-1;i+=2){var o=arguments[i],s=arguments[i+1];"number"==typeof s.id?s.id=[s.id,this.remoteNodeId,0]:2===s.id.length?s.id=[s.id[0],this.remoteNodeId,s.id[1]]:s.id=s.id.slice(0),s.id[0]=s.id[0]+this.baseTime,s.time=s.time+this.baseTime;var r=Promise.resolve([o,s]);this.options.inFilter&&(r=r.then(function(t){return e.options.inFilter(t[0],t[1]).then(function(e){return!!e&&t})})),r.then(function(t){return!!t&&(e.timeFix&&(t[1].time=t[1].time+e.timeFix),e.options.inMap?e.options.inMap(t[0],t[1]):t)}).then(function(t){return!!t&&(e.received[t[1].id.join("\t")]=!0,e.log.add(t[0],t[1]))}),n.push(r)}Promise.all(n).then(function(){e.setLastReceived(t),e.sendSynced(t)})},syncedMessage:function(t){this.endTimeout(),this.setLastSent(t),this.syncing>0&&(this.syncing-=1),0===this.syncing&&this.setState("synchronized")}}},function(t,e){t.exports={sendPing:function(){this.startTimeout(),this.send(["ping",this.lastAddedCache]),this.pingTimeout&&clearTimeout(this.pingTimeout)},pingMessage:function(t){this.setLastReceived(t),this.send(["pong",this.lastAddedCache])},pongMessage:function(t){this.setLastReceived(t),this.endTimeout()}}},function(t,e){t.exports={sendError:function(t){var e=["error",t.type];void 0!==t.options&&e.push(t.options),this.send(e),this.emitter.emit("clientError",t)},errorMessage:function(t,e){this.syncError(t,e,!0)}}},function(t,e,n){var i=n(3);function o(t,e,n,o){if(!t.options.auth)return t.authenticated=!0,void o();t.authenticating=!0,t.options.auth(n,e).then(function(e){if(e){t.authenticated=!0,t.authenticating=!1,o();for(var n=0;n<t.unauthenticated.length;n++)t.onMessage(t.unauthenticated[n]);t.unauthenticated=[]}else t.sendError(new i(t,"wrong-credentials")),t.destroy()})}function s(t,e){return t.remoteProtocol=e,e>=t.minProtocol||(t.sendError(new i(t,"wrong-protocol",{supported:t.minProtocol,used:e})),t.destroy(),!1)}function r(t){try{t.emitter.emit("connect")}catch(e){if("SyncError"===e.name)return t.sendError(e),!1;throw e}return!0}t.exports={sendConnect:function(){var t=["connect",this.localProtocol,this.localNodeId,this.lastReceived],e={};this.options.credentials&&(e.credentials=this.options.credentials),this.options.subprotocol&&(e.subprotocol=this.options.subprotocol),Object.keys(e).length>0&&t.push(e),this.options.fixTime&&(this.connectSended=this.now()),this.startTimeout(),this.send(t)},sendConnected:function(t,e){this.baseTime=e;var n=["connected",this.localProtocol,this.localNodeId,[t,e]],i={};this.options.credentials&&(i.credentials=this.options.credentials),this.options.subprotocol&&(i.subprotocol=this.options.subprotocol),Object.keys(i).length>0&&n.push(i),this.send(n)},connectMessage:function(t,e,n,i){var c=this.now();if(i||(i={}),this.remoteNodeId=e,s(this,t))if(this.remoteSubprotocol=i.subprotocol||"0.0.0",r(this)){var a=this;o(this,e,i.credentials,function(){a.sendConnected(c,a.now()),a.syncSince(n)})}else this.destroy()},connectedMessage:function(t,e,n,i){if(i||(i={}),this.endTimeout(),this.remoteNodeId=e,s(this,t)){if(this.baseTime=n[1],this.options.fixTime){var c=this.now(),a=n[1]-n[0],d=c-this.connectSended-a;this.timeFix=Math.floor(this.connectSended-n[0]+d/2)}if(this.remoteSubprotocol=i.subprotocol||"0.0.0",r(this)){var u=this;o(this,e,i.credentials,function(){u.syncSince(u.lastSent)})}else this.destroy()}}}},function(t,e,n){var i=n(0),o=n(16),s=n(15),r=n(14),c=n(13),a=n(12),d=n(3),u=[s,o,r,c,a],h=["connect","connected","error"];function l(t,e,n){var i=n.added;void 0===i&&(i=t.lastSent),t.options.outMap?t.options.outMap(e,n).then(function(e){t.sendSync(i,[e])}):t.sendSync(i,[[e,n]])}function f(t,e,n,o){if(this.localNodeId=t,this.log=e,this.connection=n,this.options=o||{},this.options.ping&&!this.options.timeout)throw new Error("You must set timeout option to use ping");this.connected=!1,this.authenticated=!1,this.authenticating=!1,this.unauthenticated=[],this.timeFix=0,this.syncing=0,this.received={},this.lastSent=0,this.lastReceived=0,this.state="disconnected",this.emitter=new i,this.timeouts=[],this.throwsError=!0,this.unbind=[];var s=this;this.unbind.push(e.on("add",function(t,e){s.onAdd(t,e)})),this.unbind.push(n.on("connecting",function(){s.onConnecting()})),this.unbind.push(n.on("connect",function(){s.onConnect()})),this.unbind.push(n.on("message",function(t){s.onMessage(t)})),this.unbind.push(n.on("error",function(t){"Wrong message format"===t.message?s.sendError(new d(s,"wrong-format",t.received)):s.error(t),s.connection.disconnect("error")})),this.unbind.push(n.on("disconnect",function(){s.onDisconnect()})),this.initialized=!1,this.lastAddedCache=0,this.initializing=this.initialize()}f.prototype={remoteNodeId:void 0,localProtocol:2,minProtocol:2,remoteProtocol:void 0,remoteSubprotocol:void 0,on:function(t,e){return this.emitter.on(t,e)},catch:function(t){this.throwsError=!1,this.on("error",t)},waitFor:function(t){if(this.state===t)return Promise.resolve();var e=this;return new Promise(function(n){var i=e.on("state",function(){e.state===t&&(i(),n())})})},destroy:function(){this.connection.destroy?this.connection.destroy():this.connected&&this.connection.disconnect("destroy");for(var t=0;t<this.unbind.length;t++)this.unbind[t]();clearTimeout(this.pingTimeout),this.endTimeout()},send:function(t){if(this.connected){this.delayPing();try{this.connection.send(t)}catch(t){this.error(t),this.connection.disconnect("error")}}},onConnecting:function(){this.setState("connecting")},onConnect:function(){this.delayPing(),this.connected=!0},onDisconnect:function(){for(;this.timeouts.length>0;)this.endTimeout();this.pingTimeout&&clearTimeout(this.pingTimeout),this.connected=!1,this.setState("disconnected")},onMessage:function(t){this.delayPing();var e=t[0];if(this.authenticated||-1!==h.indexOf(e)){for(var n=new Array(t.length-1),i=1;i<t.length;i++)n[i-1]=t[i];this[e+"Message"].apply(this,n)}else this.authenticating?this.unauthenticated.push(t):this.sendError(new d(this,"missed-auth",JSON.stringify(t)))},onAdd:function(t,e){if(this.connected)if(this.lastAddedCache<e.added&&(this.lastAddedCache=e.added),this.received[e.id.join("\t")])delete this.received[e.id.join("\t")];else if(this.options.outFilter){var n=this;this.options.outFilter(t,e).then(function(i){i&&l(n,t,e)})}else l(this,t,e)},syncError:function(t,e,n){var i=new d(this,t,e,n);this.error(i)},error:function(t){if(this.emitter.emit("error",t),this.throwsError)throw t},setState:function(t){this.state!==t&&(this.state=t,this.emitter.emit("state"))},startTimeout:function(){if(this.options.timeout){var t=this.options.timeout,e=this,n=setTimeout(function(){e.connected&&e.connection.disconnect("timeout"),e.syncError("timeout",t)},t);this.timeouts.push(n)}},endTimeout:function(){this.timeouts.length>0&&clearTimeout(this.timeouts.shift())},delayPing:function(){if(this.options.ping){this.pingTimeout&&clearTimeout(this.pingTimeout);var t=this;this.pingTimeout=setTimeout(function(){t.connected&&t.authenticated&&t.sendPing()},this.options.ping)}},syncSinceQuery:function(t){var e=this,n=[];return this.log.each({order:"added"},function(i,o){return!(o.added<=t)&&(e.options.outFilter?n.push(e.options.outFilter(i,o).then(function(t){return!!t&&[i,o]})):n.push(Promise.resolve([i,o])),!0)}).then(function(){return Promise.all(n)}).then(function(t){var e={added:0};return e.entries=t.filter(function(t){return t&&e.added<t[1].added&&(e.added=t[1].added),!1!==t}),e})},syncSince:function(t){var e=this;this.syncSinceQuery(t).then(function(t){e.connected&&(t.entries.length>0?e.options.outMap?Promise.all(t.entries.map(function(t){return e.options.outMap(t[0],t[1])})).then(function(n){e.sendSync(t.added,n)}):e.sendSync(t.added,t.entries):e.setState("synchronized"))})},setLastSent:function(t){this.lastSent<t&&(this.lastSent=t),this.log.store.setLastSynced({sent:t})},setLastReceived:function(t){this.lastReceived<t&&(this.lastReceived=t),this.log.store.setLastSynced({received:t})},now:function(){return Date.now()},initialize:function(){var t=this;return Promise.all([this.log.store.getLastSynced(),this.log.store.getLastAdded()]).then(function(e){t.initialized=!0,t.lastSent=e[0].sent,t.lastReceived=e[0].received,t.lastAddedCache=e[1],t.connection.connected&&t.onConnect()})},sendDuilian:function(){this.send(["duilian",Object.keys(v)[0]])},duilianMessage:function(t){v[t]&&this.send(["duilian",v[t]])}};for(var p=0;p<=u.length;p++){var m=u[p];for(var g in m)f.prototype[g]=m[g]}var v={"金木水火土":"板城烧锅酒"};t.exports=f},function(t,e,n){var i=n(17),o=n(2),s={fixTime:!0,timeout:2e4,ping:5e3};function r(t,e,n,r){r=o(r,s),i.call(this,t,e,n,r)}r.prototype={onConnect:function(){if(!this.connected){this.connected=!0;var t=this;this.initializing=this.initializing.then(function(){t.connected&&t.sendConnect()})}}},r.prototype=o(r.prototype,i.prototype),t.exports=r},function(t,e,n){var i=n(4);function o(t,e){return t.lastAdded+=1,e[1].added=t.lastAdded,t.added.unshift(e),Promise.resolve(e[1])}function s(t,e){for(var n=0;n<t.length;n++){var i=t[n][1].id;if(e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2])return n}return-1}function r(t){return void 0!==t}function c(){this.created=[],this.added=[],this.lastReceived=0,this.lastAdded=0,this.lastSent=0}c.prototype={add:function(t,e){for(var n=[t,e],s=e.id,r=this.created,c=0;c<r.length;c++){var a=r[c],d=a[1].id;if(s[0]===d[0]&&s[1]===d[1]&&s[2]===d[2])return Promise.resolve(!1);if(i(a[1],e)>0)return r.splice(c,0,n),o(this,n)}return r.push(n),o(this,n)},byId:function(t){var e=s(this.created,t);if(-1===e)return Promise.resolve([null,null]);var n=this.created[e];return Promise.resolve([n[0],n[1]])},remove:function(t){var e=s(this.created,t);if(-1===e)return Promise.resolve(!1);var n=[this.created[e][0],this.created[e][1]];this.created.splice(e,1);for(var i=n[1].added,o=0,r=this.added.length-1;o<=r;){var c=r+o>>1,a=this.added[c][1].added;if(a>i)o=c+1;else{if(!(a<i)){this.added.splice(c,1);break}r=c-1}}return Promise.resolve(n)},get:function(t){var e;return e="created"===t.order?this.created:this.added,Promise.resolve({entries:e.slice(0)})},changeMeta:function(t,e){var n=s(this.created,t);if(-1===n)return Promise.resolve(!1);var i=this.created[n][1];for(var o in e)i[o]=e[o];return Promise.resolve(!0)},removeReason:function(t,e,n){var o=[];return this.created=this.created.filter(function(s){var c=s[1],a=e;if(-1===c.reasons.indexOf(t))return!0;if(r(a.olderThan)&&!i(c,a.olderThan))return!0;if(r(a.youngerThan)&&!i(a.youngerThan,c))return!0;if(r(a.minAdded)&&c.added<a.minAdded)return!0;if(r(a.maxAdded)&&c.added>a.maxAdded)return!0;var d=c.reasons;return d.splice(d.indexOf(t),1),0!==c.reasons.length||(n(s[0],c),o.push(c.added),!1)}),this.added=this.added.filter(function(t){return-1===o.indexOf(t[1].added)}),Promise.resolve()},getLastAdded:function(){return Promise.resolve(this.lastAdded)},getLastSynced:function(){return Promise.resolve({received:this.lastReceived,sent:this.lastSent})},setLastSynced:function(t){return void 0!==t.sent&&(this.lastSent=t.sent),void 0!==t.received&&(this.lastReceived=t.received),Promise.resolve()}},t.exports=c},function(t,e,n){var i=n(0);function o(t){this.connected=!1,this.emitter=new i,this.url=t}o.prototype={connect:function(){if("undefined"==typeof WebSocket)throw new Error("Browser has no WebSocket support");this.emitter.emit("connecting"),this.ws=new WebSocket(this.url);var t=this;return this.ws.onerror=function(e){t.emitter.emit("error",e)},this.ws.onclose=function(){t.connected=!1,t.emitter.emit("disconnect")},this.ws.onmessage=function(e){var n;try{n=JSON.parse(e.data)}catch(n){return void t.error(e.data)}t.emitter.emit("message",n)},new Promise(function(e){t.ws.onopen=function(){t.connected=!0,t.emitter.emit("connect"),e()}})},disconnect:function(){this.ws&&(this.ws.close(),this.ws=void 0)},on:function(t,e){return this.emitter.on(t,e)},send:function(t){this.ws.send(JSON.stringify(t))},error:function(t){var e=new Error("Wrong message format");e.received=t,this.emitter.emit("error",e)}},t.exports=o},function(t,e,n){(function(e){var i=n(20),o=n(19),s=n(18),r=n(0),c=n(11),a=n(10),d=n(8),u=n(7);function h(t){localStorage.setItem(t.options.prefix+":tab:"+t.id,Date.now())}function l(t,e){t.log.removeReason("tab"+e).then(function(){t.isLocalStorage&&localStorage.removeItem(t.options.prefix+":tab:"+e)})}var f=["id","time","nodeIds","users","channels"];function p(t){if(this.options=t||{},void 0===this.options.prefix&&(this.options.prefix="logux"),this.id=a(8),this.options.userId=this.options.userId.toString(),this.isLocalStorage=!1,"undefined"!=typeof localStorage)try{localStorage.setItem(this.id,"1"),localStorage.removeItem(this.id),this.isLocalStorage=!0}catch(t){}var n;this.nodeId=this.options.userId+":"+this.id,/^ws:\/\//.test(this.options.server)&&!t.allowDangerousProtocol&&(n=function(t){return"object"!=typeof t||"development"!==t.env?(console.error("Without SSL, old proxies blocks WebSockets. Use WSS for Logux or set allowDangerousProtocol option."),Promise.resolve(!1)):Promise.resolve(!0)});var l,p=this.options.store;p||(p=e.indexedDB?new u(this.options.prefix+":"+this.options.userId):new o),l=this.options.time?this.options.time.nextLog({store:p,nodeId:this.nodeId}):new d({store:p,nodeId:this.nodeId}),this.log=l;var m=this;function g(t,e){var n,i=t.type;"logux/subscribe"===i?(n=JSON.stringify(t),m.subscriptions.some(function(e){return e.channel===t.channel&&JSON.stringify(e)===n})||m.subscriptions.push(t)):"logux/unsubscribe"===i&&(n=JSON.stringify(function(t){var e={};for(var n in t)"type"===n?e.type="logux/subscribe":e[n]=t[n];return e}(t)),m.subscriptions=m.subscriptions.filter(function(e){return e.channel!==t.channel||JSON.stringify(e)!==n}))}l.on("preadd",function(t,e){e.id[1]!==m.nodeId||e.subprotocol||(e.subprotocol=m.options.subprotocol)}),this.subscriptions=[],this.emitter=new r,this.on?this.on("add",g):l.on("add",g),this.tabPing=6e4,this.tabTimeout=10*this.tabPing;var v,y="tab"+m.id;if(this.isLocalStorage)var w=l.on("add",function(t,e){-1!==e.reasons.indexOf(y)&&(h(m),m.pinging=setInterval(function(){h(m)},m.tabPing),w())});if("string"==typeof this.options.server){var b=new i(this.options.server);v=new c(b,{minDelay:this.options.minDelay,maxDelay:this.options.maxDelay,attempts:this.options.attempts})}else v=this.options.server;this.sync=new s(this.nodeId,this.log,v,{credentials:this.options.credentials,subprotocol:this.options.subprotocol,outFilter:function(t,e){var n=e.id[1].replace(/:[^:]*$/,"");return Promise.resolve(!!e.sync&&n===m.options.userId)},timeout:this.options.timeout,outMap:function(t,e){var n={};for(var i in e)-1!==f.indexOf(i)&&(n[i]=e[i]),e.subprotocol&&e.subprotocol!==m.options.subprotocol&&(n.subprotocol=e.subprotocol);return Promise.resolve([t,n])},ping:this.options.ping,auth:n}),this.sync.on("debug",function(t,e){"error"===t&&console.error("Error on Logux server:\n",e)});var S=!0;this.sync.on("state",function(){if("synchronized"===m.sync.state&&S)for(var t in S=!1,m.subscriptions)m.log.add(m.subscriptions[t],{sync:!0});else"disconnected"===m.sync.state&&(S=!0)}),this.onUnload=this.onUnload.bind(this),"undefined"!=typeof window&&window.addEventListener("unload",this.onUnload)}p.prototype={start:function(){this.cleanPrevActions(),this.sync.connection.connect()},destroy:function(){this.onUnload(),this.sync.destroy(),clearInterval(this.pinging),"undefined"!=typeof window&&window.removeEventListener("unload",this.onUnload)},clean:function(){return this.destroy(),this.log.store.clean?this.log.store.clean():Promise.resolve()},cleanPrevActions:function(){if(this.isLocalStorage)for(var t in localStorage){var e=this.options.prefix+":tab:";if(t.slice(0,e.length)===e){var n=parseInt(localStorage.getItem(t));Date.now()-n>this.tabTimeout&&l(this,t.slice(e.length))}}},onUnload:function(){this.pinging&&l(this,this.id)}},t.exports=p}).call(this,n(1))},function(t,e,n){var i=n(2),o=n(21);function s(t,e){return t.options.prefix+":"+t.options.userId+":"+e}function r(t,e,n){t.isLocalStorage&&localStorage.setItem(s(t,e),JSON.stringify(n))}function c(t){var e=localStorage.getItem(s(t,"leader")),n=[];return"string"==typeof e&&(n=JSON.parse(e)),n}function a(t){r(t,"leader",[t.id,Date.now()])}function d(t){"disconnected"!==t.state&&p(t,"disconnected"),f(t)}function u(t){clearTimeout(t.watching),t.watching=setTimeout(function(){l(t)?u(t):d(t)},t.roleTimeout)}function h(t,e){if(t.role!==e){var n=t.sync;if(t.role=e,clearTimeout(t.watching),"leader"===e?(localStorage.removeItem(s(t,"state")),t.leadership=setInterval(function(){t.unloading||a(t)},t.leaderPing),n.connection.connect()):(clearTimeout(t.elections),clearInterval(t.leadership),"disconnected"!==n.state&&t.sync.connection.disconnect()),"follower"===e){var i="disconnected",o=localStorage.getItem(s(t,"state"));o&&null!==o&&(i=JSON.parse(o)),i!==t.state&&(t.state=i,t.emitter.emit("state"))}t.emitter.emit("role")}}function l(t){var e=c(t);return e[1]&&e[1]>=Date.now()-t.leaderTimeout}function f(t){a(t),h(t,"candidate"),t.elections=setTimeout(function(){c(t)[0]===t.id?h(t,"leader"):(h(t,"follower"),u(t))},t.electionDelay)}function p(t,e){t.state=e,t.emitter.emit("state"),r(t,"state",t.state)}function m(t){return t.created&&t.added}function g(t){o.call(this,t),this.role="candidate",this.roleTimeout=3e3+Math.floor(1e3*Math.random()),this.leaderTimeout=5e3,this.leaderPing=2e3,this.electionDelay=1e3,this.state=this.sync.state;var e=this;this.sync.on("state",function(){"leader"===e.role&&p(e,e.sync.state)}),this.log.on("add",function(t,n){e.emitter.emit("add",t,n),n.tab!==e.id&&r(e,"add",[e.id,t,n])}),this.log.on("clean",function(t,n){e.emitter.emit("clean",t,n),n.tab!==e.id&&r(e,"clean",[e.id,t,n])}),this.onStorage=this.onStorage.bind(this),this.onUnload=this.onUnload.bind(this),"undefined"!=typeof window&&(window.addEventListener("storage",this.onStorage),window.addEventListener("unload",this.onUnload))}g.prototype={start:function(){if(this.cleanPrevActions(),!this.isLocalStorage)return this.role="leader",this.emitter.emit("role"),void this.sync.connection.connect();l(this)?(h(this,"follower"),u(this)):f(this)},destroy:function(){o.prototype.destroy.call(this),clearTimeout(this.watching),clearTimeout(this.elections),clearInterval(this.leadership),"undefined"!=typeof window&&window.removeEventListener("storage",this.onStorage)},clean:function(){return this.isLocalStorage&&(localStorage.removeItem(s(this,"add")),localStorage.removeItem(s(this,"clean")),localStorage.removeItem(s(this,"state")),localStorage.removeItem(s(this,"leader"))),o.prototype.clean.call(this)},on:function(t,e){return this.emitter.on(t,e)},onStorage:function(t){var e;if(null!==t.newValue)if(t.key===s(this,"add"))(e=JSON.parse(t.newValue))[0]!==this.id&&(e[2].tab&&e[2].tab!==this.id||(m(this.log.store)&&this.log.store.add(e[1],e[2]),this.emitter.emit("add",e[1],e[2]),"leader"===this.role&&this.sync.onAdd(e[1],e[2])));else if(t.key===s(this,"clean"))(e=JSON.parse(t.newValue))[0]!==this.id&&(e[2].tab&&e[2].tab!==this.id||(m(this.log.store)&&this.log.store.remove(e[2].id),this.emitter.emit("clean",e[1],e[2])));else if(t.key===s(this,"leader"))0===(e=JSON.parse(t.newValue)).length?d(this):e[0]!==this.id&&"candidate"!==this.role&&(h(this,"follower"),u(this));else if(t.key===s(this,"state")){var n=JSON.parse(localStorage.getItem(t.key));this.state!==n&&(this.state=n,this.emitter.emit("state"))}},onUnload:function(){"leader"===this.role&&(this.unloading=!0,r(this,"leader",[])),o.prototype.onUnload.call(this)}},g.prototype=i(g.prototype,o.prototype),Object.defineProperty(g.prototype,"connected",{get:function(){return"disconnected"!==this.state&&"connecting"!==this.state}}),t.exports=g},function(t,e,n){var i=n(22),o=document.querySelector("meta[name=user]"),s=document.querySelector("meta[name=token]"),r=document.querySelector("meta[name=server]"),c=new i({credentials:s.content,subprotocol:"1.0.0",server:r.content,userId:o.content});c.start(),document.querySelector("#btn").addEventListener("click",function(){console.log("Click"),c.log.add({type:"ADD_STUFF"},{reasons:["sync"]})},!1),c.on("add",function(t,e){"ADD_STUFF"===t.type&&(stack=document.querySelector("#stack"),stack.innerHTML+="stuff")})}]);